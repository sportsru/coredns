# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Test, Build and Publish
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release:
        description: "Release"
        required: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '~1.20.0'
        id: go

      - name: Build
        run: go build -v ./...

      - name: Test
        run: |
          ( cd request; go test -race ./... )
          ( cd core; go test -race  ./... )
          ( cd coremain; go test -race ./... )

  test-plugins:
    name: Test Plugins
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '~1.20.0'
        id: go

      - name: Build
        run: go build -v ./...

      - name: Test
        run: ( cd plugin; go test -race ./... )

  build:
    name: Build and publish
    runs-on: ubuntu-latest
    steps:

      - name: Lowercase name
        uses: ASzc/change-string-case-action@v5
        with:
          string: coredns_${{ github.ref_name }}_${{ runner.os }}_${{ runner.arch }}.tgz

      - name: Check out code
        uses: actions/checkout@v3

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '~1.20.0'
        id: go

      - name: Build
        run: make

      - name: Zip Build
        run: |
          tar -cz coredns -f ${{ steps.string.outputs.lowercase }}
          sha256sum ${{ steps.string.outputs.lowercase }} > ${{ steps.string.outputs.lowercase }}.sha256
          ls -lah

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ steps.string.outputs.lowercase }}
            ${{ steps.string.outputs.lowercase }}.sha256
